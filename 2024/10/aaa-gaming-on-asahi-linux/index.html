<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<title>AAA gaming on Asahi Linux - Asahi Linux</title><link rel=stylesheet href=/css/main.css?d133f651>
<link href=https://use.fontawesome.com/releases/v6.7.1/css/all.css rel=stylesheet>
<link rel=preconnect href=https://fonts.gstatic.com>
<link id=favicon rel=icon href=/img/AsahiLinux_logomark_32px.png>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&family=Noto+Sans+JP:wght@300;500;700&family=Noto+Serif+JP:wght@200;500&family=Varela+Round&display=swap" rel=stylesheet>
<meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,user-scalable=yes">
<meta name=twitter:card content="summary">
<meta name=twitter:site content="@AsahiLinux">
<meta name=twitter:creator content="@AsahiLinux">
<meta name=twitter:title content="AAA gaming on Asahi Linux - Asahi Linux">
<meta name=twitter:description content="Porting Linux to Apple Silicon">
<meta name=twitter:image content="https://asahilinux.org/img/AsahiLinux_logomark_256px.png">
<meta name=twitter:image:width content="256">
<meta name=twitter:image:height content="256">
<meta property="og:image" content="https://asahilinux.org/img/AsahiLinux_logomark_256px.png">
<meta property="og:title" content="AAA gaming on Asahi Linux - Asahi Linux">
<script>var kawaii=new URLSearchParams(window.location.search).get("kawaii")??localStorage.getItem("kawaii");kawaii=="true"?(document.documentElement.classList.add("kawaii"),localStorage.setItem("kawaii","true")):localStorage.removeItem("kawaii")</script>
</head><body>
<header id=header>
<div class=header-logo>
<a href=/><img src=/img/AsahiLinux_logo.svg?d619e737 class=logo alt></a>
</div><div class=header-menu>
<ul class="menu-container flex-container">
<li><a href=/about>About</a></li><li><a href=/community>Community</a></li><li><a href=/contribute>Contribute</a></li><li><a href=/governance>Governance</a></li><li><a href=/docs>Documentation</a></li><li><a href=https://github.com/AsahiLinux>GitHub</a></li><li><a href=/blog>Blog</a></li><li><a href=/support>Donate</a></li></ul></div></header><section id=post-section>
<div class=post-wrapper>
<div class=post>
<div id=breadcrumbs>
<a href=https://asahilinux.org/>
<i class="fas fa-home"></i>
</a>
/
<a href=https://asahilinux.org/blog/>
Blog
</a>
/
<a href=https://asahilinux.org/2024/10/aaa-gaming-on-asahi-linux/>
AAA gaming on Asahi Linux
</a>
</div><div class=blog-header>
<h1 class=entry-title>AAA gaming on Asahi Linux</h1><ul class=blog-nav>
<li>
<a href=https://asahilinux.org/2024/06/vk13-on-the-m1-in-1-month/><i class="fas fa-arrow-left"></i>Previous</a>
</li><li class=nav-spacer></li><li>
<a class=next href=https://asahilinux.org/2024/12/muvm-x11-bridging/>Next<i class="fas fa-arrow-right"></i></a>
</li></ul></div><p>Gaming on Linux on M1 is here! We&rsquo;re thrilled to release our Asahi game playing
toolkit, which integrates our Vulkan 1.3 drivers with x86 emulation and Windows
compatibility. Plus a bonus: conformant OpenCL 3.0.</p><p>Asahi Linux now ships the only conformant <a href=https://www.khronos.org/conformance/adopters/conformant-products/opengl#submission_3470>OpenGL®</a>,
<a href=https://www.khronos.org/conformance/adopters/conformant-products/opencl#submission_433>OpenCL™</a>, and
<a href=https://www.khronos.org/conformance/adopters/conformant-products#submission_7910>Vulkan®</a>
drivers for this hardware. As for gaming&mldr; while today&rsquo;s release is an alpha, <a href=https://store.steampowered.com/app/870780/Control_Ultimate_Edition/><strong>Control</strong></a> runs well!</p><figure><a href=/img/blog/2024/10/Control-small.png><img src=/img/blog/2024/10/Control-small.avif alt=Control></a></figure><h2 id=installation>Installation</h2><p>First, install <a href=https://asahilinux.org/fedora/>Fedora Asahi Remix</a>. Once
installed, get the latest drivers with <code style=white-space:nowrap>dnf
upgrade --refresh && reboot</code>. Then just <code style=white-space:nowrap>dnf install steam</code> and play. While all M1/M2-series systems work, most games require 16GB of memory due to emulation overhead.</p><h2 id=the-stack>The stack</h2><p>Games are typically x86 Windows binaries rendering with DirectX, while our target is Arm Linux
with Vulkan. We need to handle each difference:</p><ul>
<li><a href=https://fex-emu.com/>FEX</a> emulates x86 on Arm.</li><li><a href=https://www.winehq.org/>Wine</a> translates Windows to Linux.</li><li><a href=https://github.com/doitsujin/dxvk>DXVK</a> and <a href=https://github.com/HansKristian-Work/vkd3d-proton>vkd3d-proton</a> translate DirectX to Vulkan.</li></ul><p>There&rsquo;s one curveball: page size. Operating systems allocate memory in fixed
size &ldquo;pages&rdquo;. If an application expects smaller pages than the system uses,
they will break due to insufficient alignment of allocations. That&rsquo;s a problem:
x86 expects 4K pages but Apple systems use 16K pages.</p><p>While Linux can&rsquo;t mix page sizes between processes, it <em>can</em> virtualize another
Arm Linux kernel with a different page size. So we run games inside a tiny
virtual machine using <a href=https://github.com/AsahiLinux/muvm>muvm</a>, passing through
devices like the GPU and game controllers. The
hardware is happy because the system is 16K, the game is happy because the
virtual machine is 4K, and you&rsquo;re happy because you can play <a href=https://store.steampowered.com/app/377160/Fallout_4/><strong>Fallout
4</strong></a>.</p><figure><a href=/img/blog/2024/10/Fallout4-small.png><img src=/img/blog/2024/10/Fallout4-small.avif alt="Fallout 4"></a></figure><h2 id=vulkan>Vulkan</h2><p>The final piece is an adult-level Vulkan driver, since translating DirectX requires Vulkan 1.3
with many extensions. Back in April, I wrote
<a href=https://rosenzweig.io/blog/vk13-on-the-m1-in-1-month.html>Honeykrisp</a>, the
only Vulkan 1.3 driver for Apple hardware. I&rsquo;ve since added DXVK support. Let&rsquo;s look at some new features.</p><h3 id=tessellation>Tessellation</h3><p>Tessellation enables games like <a href=https://store.steampowered.com/app/292030/The_Witcher_3_Wild_Hunt/><strong>The Witcher 3</strong></a> to generate
geometry. The M1 has hardware tessellation, but it is
too limited for DirectX, Vulkan, or OpenGL. We must instead tessellate with arcane compute shaders, as detailed in <a href=https://www.youtube.com/live/pDsksRBLXPk>today&rsquo;s talk at XDC2024</a>.</p><figure><a href=/img/blog/2024/10/Witcher3-small.png><img src=/img/blog/2024/10/Witcher3-small.avif alt="The Witcher 3"></a></figure><h3 id=geometry-shaders>Geometry shaders</h3><p>Geometry shaders are an older, cruder method to generate geometry. Like
tessellation, the M1 lacks geometry shader hardware so we emulate with compute.
Is that fast? No, but geometry shaders are slow <a href="http://www.joshbarczak.com/blog/?p=667">even on desktop
GPUs</a>. They don&rsquo;t need to be fast &ndash;
just fast enough for games like
<a href=https://store.steampowered.com/app/1139900/Ghostrunner/><strong>Ghostrunner</strong></a>.</p><figure><a href=/img/blog/2024/10/Ghostrunner-small.png><img src=/img/blog/2024/10/Ghostrunner-small.avif alt=Ghostrunner></a></figure><h3 id=enhanced-robustness>Enhanced robustness</h3><p>&ldquo;Robustness&rdquo; permits an application&rsquo;s shaders to access buffers out-of-bounds
without crashing the hardware. In OpenGL and Vulkan, out-of-bounds loads may
return arbitrary elements, and out-of-bounds stores may corrupt the buffer.
Our OpenGL driver <a href=https://rosenzweig.io/blog/conformant-gl46-on-the-m1.html>exploits this
definition</a> for
efficient robustness on the M1.</p><p>Some games require stronger guarantees. In DirectX, out-of-bounds loads return zero, and
out-of-bounds stores are ignored. DXVK therefore requires
<a href=https://docs.vulkan.org/guide/latest/robustness.html#_vk_ext_robustness2><code>VK_EXT_robustness2</code></a>,
a Vulkan extension strengthening robustness.</p><p>Like before, we implement robustness with compare-and-select instructions. A
naïve implementation would <em>compare</em> a loaded index with the buffer size and
<em>select</em> a zero result if out-of-bounds. However, our GPU loads are vector
while arithmetic is scalar. Even if we disabled page faults, we would need up
to four compare-and-selects per load.</p><div class=highlight><pre tabindex=0 style=color:#c9c9c9color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#57c7ff>load</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>*</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>16</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>0</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>0</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>0</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>1</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>1</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>0</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>2</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>2</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>0</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>3</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>[</span><span style=color:#56b6c2>3</span><span style=color:#56b6c2>],</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>0</span><span style=color:#c9c9c9>
</span></span></span></code></pre></div><p>There&rsquo;s a trick: reserve <em>64 gigabytes</em> of zeroes using virtual memory voodoo.
Since every 32-bit index multiplied by 16 fits in 64 gigabytes, any index into
this region loads zeroes. For out-of-bounds loads, we simply replace the buffer
address with the reserved address while preserving the index. Replacing a
64-bit address costs just two 32-bit compare-and-selects.</p><div class=highlight><pre tabindex=0 style=color:#c9c9c9color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer.lo</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer.lo</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>RESERVED.lo</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>ulesel</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer.hi</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>size</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer.hi</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>RESERVED.hi</span><span style=color:#c9c9c9>
</span></span></span><span style=display:flex;color:#c9c9c9><span style=color:#c9c9c9><span style=color:#c9c9c9></span><span style=color:#57c7ff>load</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>R</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>buffer</span><span style=color:#56b6c2>,</span><span style=color:#c9c9c9> </span><span style=color:#ecbe7b>index</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>*</span><span style=color:#c9c9c9> </span><span style=color:#56b6c2>16</span><span style=color:#c9c9c9>
</span></span></span></code></pre></div><p>Two instructions, not four.</p><h2 id=next-steps>Next steps</h2><p>Sparse texturing is next for Honeykrisp, which will unlock more DX12 games. The alpha already runs DX12 games that don&rsquo;t require sparse, like <a href=https://store.steampowered.com/app/1091500/Cyberpunk_2077/><strong>Cyberpunk
2077</strong></a>.</p><figure><a href=/img/blog/2024/10/Cyberpunk2077-small.png><img src=/img/blog/2024/10/Cyberpunk2077-small.avif alt="Cyberpunk 2077"></a></figure><p>While many games are playable, newer AAA titles don&rsquo;t hit 60fps <em>yet</em>.
Correctness comes first. Performance improves next. Indie games like
<a href=https://store.steampowered.com/app/367520/Hollow_Knight/><strong>Hollow Knight</strong></a> do run full speed.</p><figure><a href=/img/blog/2024/10/HollowKnight-small.png><img src=/img/blog/2024/10/HollowKnight-small.avif alt="Hollow Knight"></a></figure><p>Beyond gaming, we&rsquo;re adding general purpose x86 emulation based on this
stack. For more information, <a href=https://docs.fedoraproject.org/en-US/fedora-asahi-remix/x86-support/>see the
FAQ</a>.</p><p>Today&rsquo;s alpha is a taste of what&rsquo;s to come. Not the final form, but
enough to enjoy <a href=https://store.steampowered.com/app/620/Portal_2/><strong>Portal 2</strong></a> while we work towards &ldquo;1.0&rdquo;.</p><figure><a href=/img/blog/2024/10/Portal2-small.png><img src=/img/blog/2024/10/Portal2-small.avif alt="Portal 2"></a></figure><h2 id=acknowledgements>Acknowledgements</h2><p>This work has been years in the making with major contributions from&mldr;</p><ul>
<li><a href=https://rosenzweig.io>Alyssa Rosenzweig</a></li><li><a href=https://lina.yt/me>Asahi Lina</a></li><li><a href=https://social.treehouse.systems/@chaos_princess>chaos_princess</a></li><li><a href=https://github.com/davide125>Davide Cavalca</a></li><li><a href=https://mastodon.social/@dougall>Dougall Johnson</a></li><li><a href=https://ella.gay>Ella Stanforth</a></li><li><a href=https://www.gfxstrand.net/faith/welcome/>Faith Ekstrand</a></li><li><a href=https://social.treehouse.systems/@janne>Janne Grunau</a></li><li><a href=https://chaos.social/@karolherbst>Karol Herbst</a></li><li><a href=https://social.treehouse.systems/@marcan>marcan</a></li><li><a href=https://mary.zone>Mary Guillemard</a></li><li><a href=https://neal.gompa.dev/>Neal Gompa</a></li><li><a href=https://sinrega.org>Sergio López</a></li><li><a href=https://github.com/TellowKrinkle>TellowKrinkle</a></li><li><a href=https://github.com/teohhanhui>Teoh Han Hui</a></li><li><a href=https://mastodon.gamedev.place/@robclark>Rob Clark</a></li><li><a href=https://github.com/sonicadvance1>Ryan Houdek</a></li></ul><p>&mldr; Plus hundreds of developers whose work we build upon, spanning the Linux,
Mesa, Wine, and FEX projects. Today&rsquo;s release is
thanks to the magic of open source.</p><p>We hope you enjoy the magic.</p><p>Happy gaming.</p><div class=post-bottom>Alyssa Rosenzweig · <span class=publishdate>2024-10-10</span></div></div></div></section><footer id=footer>
<div class=footer-menu>
<div class=footer-logo>
<a href=/>
<img src=/img/AsahiLinux_logomark.svg class=logo alt="Asahi Linux logo">
</a>
<span class=license>Licensed under CC BY-SA 4.0</span>
<span class=disclaimer>Linux® is the registered trademark of Linus Torvalds in the U.S. and other countries. All other product names, logos, and brands are property of their respective owners.
<span class=kawaii-disclaimer>Kawaii Asahi Linux logo by <a href=https://github.com/SAWARATSUKI/Logos>SAWARATSUKI</a> (see link for license).</span>
</span>
</div><div class=footer-links>
<ul class=footer-services>
<li><a href=https://social.treehouse.systems/@AsahiLinux><i class="fab fa-mastodon"></i></a></li><li><a href=https://bsky.app/profile/asahilinux.org><i class="fab fa-bluesky"></i></a></li><li><a href=https://www.linkedin.com/company/asahilinux/><i class="fab fa-linkedin"></i></a></li><li><a href=https://github.com/AsahiLinux><i class="fab fa-github"></i></a></li></ul><ul class=footer-menu-container>
<li><a href=/about>About</a></li><li><a href=/code-of-conduct>Code of Conduct</a></li><li><a href=/copyright>Copyright policy</a></li></ul></div></div></footer></body></html>